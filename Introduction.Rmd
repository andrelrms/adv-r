\mainmatter

```{r, include = FALSE}
source("common.R")
```

# Introdução

Atualmente, programo em R há mais de 15 anos e faço isso em tempo integral nos 
últimos cinco anos. Isso me deu o luxo de ter tempo para examinar como a 
linguagem funciona. Este livro é minha tentativa de transmitir o que aprendi 
para que você possa entender as complexidades do R de maneira mais rápida e 
indolor possível. A leitura ajudará a evitar os erros que cometi e os becos sem 
saída que entrei e ensinará ferramentas, técnicas e expressões úteis que podem 
lhe ajudar a atacar muitos tipos de problemas. No processo, espero mostrar que, 
apesar de suas peculiaridades às vezes frustrantes, o R é, em seu coração, uma 
linguagem elegante e bonita, bem adaptada à ciência de dados.

## Por que R?

Se você está comecando agora no R, pode estar considerando se vale a pena 
aprender um idioma tão peculiar. Para mim, algumas das melhores características 
são:

* É gratuito, de código aberto e disponível em todas as principais plataformas. 
  Como resultado, se você fizer sua análise em R, qualquer pessoa poderá 
  replicá-la facilmente, independentemente de onde mora ou quanto dinheiro 
  ganha.

* R tem uma comunidade diversificada e acolhedora, tanto online (por exemplo, 
  [a comunidade do #rstats no twitter][rstats-twitter]) quanto pessoalmente 
  (como os [muitos encontros (meetups) do R][r-meetups]). Dois grupos 
  comunitários particularmente inspiradores são o 
  [boletim de notícias semanal - rweekly (em inglês)][rweekly] -, que facilita 
  manter-se atualizado com o R e [R-Ladies][r-ladies] (e o 
  [R-Ladies Brasil](https://rladies.org/brazil-rladies/) - nota do tradutor), 
  que criaram uma comunidade maravilhosamente acolhedora para mulheres e outros 
  gêneros minoritários.
  
* Tem um conjunto enorme de pacotes para modelagem estatística, aprendizado de 
  máquina, visualização, importação e manipulação de dados. Qualquer que seja o 
  modelo ou gráfico que você esteja tentando fazer, é provável que alguém já 
  tenha tentado fazê-lo e você pode aprender com os esforços dessas pessoas.

* Ferramentas poderosas para comunicar seus resultados. [RMarkdown][rmarkdown] 
  facilita a conversão de resultados em arquivos HTML, PDFs, documentos do Word,
  apresentações em PowerPoint, painéis e muito mais. 
  [Shiny][shiny] permite criar belos aplicativos interativos sem nenhum 
  conhecimento de HTML ou javascript.
  
* O RStudio, [o IDE](http://www.rstudio.com/ide/) (sigla para integrated 
  development environment, ou ambiente de desenvolvimento integrado - nota do 
  tradutor), fornece um ambiente de desenvolvimento integrado, adaptado às 
  necessidades de ciência de dados, análise interativa de dados e programação 
  estatística.  
  
* Ferramentas de ponta. Pesquisadores em estatística e aprendizado de máquina 
  costumam publicar um pacote em R para acompanhar seus artigos. Isso significa 
  acesso imediato às mais recentes técnicas e implementações estatísticas.

* Suporte amplo à linguagem para análise de dados. Isso inclui recursos como 
  valores ausentes (missing - nota do tradutor), estrutura de dados (data 
  frame - nota do tradutor) e vetorização.

* Uma base sólida de programação funcional. As idéias de programação funcional
  são bem adaptadas aos desafios da ciência de dados e o núcleo da linguagem R é
  funcional e fornece muitas funções primitivas necessárias para uma programação
  funcional eficaz.
  
* RStudio, [a empresa](https://www.rstudio.com), que ganha dinheiro com a venda 
  de produtos profissionais para equipes de usuários de R, investe muito desse 
  dinheiro na comunidade de código aberto (mais de 50% dos engenheiros de 
  software do RStudio trabalham em projetos de código aberto). Eu trabalho para 
  o RStudio porque acredito fundamentalmente em sua missão.  

* Poderosas ferramentas de metaprogramação. Os recursos de metaprogramação do R 
  permitem que você escreva funções concisas e magicamente sucintas e fornece um
  excelente ambiente para desenvolver linguagens de domínio específicas, como 
  ggplot2, dplyr, data.table e muito mais.

* A facilidade com que o R pode se conectar a linguagens de programação de alto 
  desempenho como C, Fortran e C ++.

Claro, R não é perfeito. O maior desafio do R (e uma oportunidade!) é que a 
maioria das pessoas que usa o R não é composta por programadorxs. Isso significa 
que:

* Grande parte do código R que você verá por aí é escrito às pressas para 
  resolver um problema imediato. Como resultado, o código não é muito elegante, 
  rápido ou fácil de entender. A maioria das pessoas não revisa seus códigos 
  para solucionar essas deficiências.

* Comparada a outras linguagens de programação, a comunidade R está mais focada 
  em resultados do que em processos. O conhecimento das melhores práticas de 
  engenharia de software é irregular. Por exemplo, poucas pessoas que programam
  em R usam controle de código fonte ou testes automatizados.

* A metaprogramação é uma faca de dois gumes. Muitas funções no R usam truques 
  para reduzir a quantidade de digitação, ao custo de criar um código difícil de 
  entender e que pode falhar de maneiras inesperadas.

* A inconsistência é comum entre os pacotes feitos pela comunidade e, até mesmo, 
  entre os pacotes-base do R. Você tem de lidar com mais de 25 anos de 
  evolução toda vez que usa o R e isso pode tornar o aprendizado difícil, 
  pois há muitos casos especiais para lembrar.

* R não é uma linguagem de programação particularmente rápida e o um código em R 
  mal escrito pode ser incrivelmente lento. O R também usa muita memória.

Pessoalmente, acho que esses desafios criam uma grande oportunidade para 
programadorxs experientes terem um impacto positivo e profundo no R e na 
comunidade R. As pessoas que usam R de fato se preocupam em escrever códigos 
de alta qualidade, principalmente em pesquisas reproduzíveis, mas ainda não têm as 
habilidades necessárias para fazê-lo. Espero que este livro não apenas ajude 
mais usuárixs do R a se tornarem programadorxs em R, mas também incentive 
programadorxs de outras línguagens a contribuírem com o R.

## Quem deve ler esse livro? {#who-should-read}

Este livro é destinado a dois públicos complementares:

* Programadorxs que possuem um conhecimento intermediário em R e que desejam 
  aprofundar-se no R, entender como a linguagem funciona e aprender novas 
  estratégias para resolver diversos problemas.

* Programadorxs que vêm de outros idiomas e que estão aprendendo R e querem 
  entender os porquês do R funcionar da maneira que funciona.
  
Para tirar o máximo proveito deste livro, você precisará ter escrito uma 
quantidade razoável de código em R ou em outra linguagem de programação. Você 
deve estar familiarizadx com o básico da análise de dados (ou seja, importação, 
manipulação e visualização de dados), ter escrito várias funções e estar 
familiarizadx com a instalação e o uso de pacotes do CRAN.

Este livro percorre a linha estreita entre ser um livro de referência (usado 
principalmente para pesquisa) e ser linearmente legível. Isso envolve alguns 
comprometimentos, pois é difícil linearizar o material e, ao mesmo tempo, manter 
temas relacionados juntos - e alguns conceitos são muito mais fáceis de explicar 
se você já está familiarizado com o vocabulário técnico específico. 
Tentei usar notas de rodapé e referências cruzadas para garantir que você ainda 
possa entender o material, mesmo que apenas mergulhe os dedos dos pés em um 
capítulo.

## O que você obterá deste livro {#what-you-will-get}

Este livro fornece o conhecimento que eu acho que uma pessoa que programa de 
forma avançada no R deve possuir: uma compreensão profunda dos fundamentos 
juntamente com um vocabulário amplo, o que significa que você pode aprender 
mais sobre um tópico de forma estratégica, quando necessário.

Após ler este livro, você:

* Estará familiarizadx com os fundamentos do R. Você entenderá os complexos
  tipos de dados e as melhores maneiras de executar operações neles. 
  Você terá um profundo entendimento de como as funções funcionam, saberá o que 
  são ambientes e como fazer uso das condições de exceção.

* Entenderá o que significa programação funcional e por que é uma ferramenta 
  útil para ciência de dados. Você poderá aprender rapidamente como usar as 
  ferramentas existentes e terá o conhecimento para criar suas próprias 
  ferramentas funcionais quando necessário.

* Conhecerá a rica variedade de sistemas orientados a objetos do R. Você se 
  familiarizará mais com o S3, mas você conhecerá o S4 e o R6 e saberá procurar 
  mais informações quando necessário.
  
* Apreciará a faca de dois gumes da metaprogramação. Você poderá criar funções 
  que usam avaliação organizada (tidy evaluation - nota do tradutor), 
  o que lhe fará economizar a quantidade de código digitada e permitirá escrever 
  código de forma elegante para expressar operações importantes. 
  Você também entenderá os perigos e quando evitá-los.

* Terá uma boa intuição para identificar quais operações no R são lentas ou usam
  muita memória. Você saberá como usar criação de perfis para identificar 
  gargalos de desempenho e conhecerá C++ suficiente para converter funções 
  lentas do R em equivalentes rápidos em C++.

## O que você não aprenderá

Este livro é sobre R, a linguagem de programação, não R como ferramenta de 
análise de dados. Se você deseja melhorar suas habilidades em ciência de dados, 
recomendo que aprenda sobre o [tidyverse](https://www.tidyverse.org/)(em 
inglês), uma coleção de pacotes consistentes, desenvolvida por mim e meus 
colegas. Neste livro, você aprenderá as técnicas usadas para desenvolver os 
pacotes do tidyverse; se você quiser aprender a usar os pacotes, recomendo 
[_R for Data Science_](http://r4ds.had.co.nz/)(R para Ciência de Dados - em 
inglês).

Se você deseja compartilhar seu código R com outras pessoas, precisará criar um 
pacote para o R. Isso permite agrupar o código junto com a documentação e os 
testes de unidade, e distribuí-lo facilmente via CRAN. Na minha opinião, a 
maneira mais fácil de desenvolver pacotes é com [devtools](http://devtools.r-lib.org), [roxygen2](http://klutometis.github.io/roxygen/), [testthat](http://testthat.r-lib.org) 
e [usethis](http://usethis.r-lib.org). Você pode aprender como usar esses
pacotes para criar o seu em [_R packages_](http://r-pkgs.had.co.nz/) (os 
links anteriores levam à páginas em inglês - nota do tradutor).

## Meta-técnicas {#meta-techniques}

Existem duas meta-técnicas que são tremendamente úteis para melhorar suas 
habilidades de programação com R: ler o código-fonte e adotar uma mentalidade 
científica.

A leitura do código-fonte é importante porque lhe ajudará a escrever um código 
melhor. Um ótimo lugar para começar a desenvolver essa habilidade é examinar o 
código-fonte das funções e pacotes que você usa com mais frequência. Você 
encontrará coisas que valem a pena emular no seu próprio código e desenvolverá 
uma sensibilidade para identificar o que faz um código R ser bom. Você também 
verá coisas que não gosta, ou porque tais coisas possuem virtudes que não são 
óbvias ou porque elas ofendem a sua sensibilidade. No entanto, esse código é 
valioso, pois ajuda a solidificar suas opiniões sobre quais códigos são bons e 
quais são ruins.

Uma mentalidade científica é extremamente útil ao aprender R. Se você não 
entende como algo funciona, você deve desenvolver uma hipótese, desenhar alguns experimentos, executá-los e registrar os resultados. Este exercício é 
extremamente útil, pois se você não conseguir descobrir algo e precisar de 
ajuda, poderá mostrar facilmente o que tentou para outras pessoas. Além disso, 
quando você aprender a resposta certa, estará mentalmente preparadx para 
atualizar sua visão de mundo.

## Leitura recomendada {#recommended-reading}

Como a comunidade R é composta principalmente por cientistas de dados, e não 
cientistas da computação, há relativamente poucos livros que se aprofundam nos 
fundamentos técnicos do R. Em minha jornada pessoal para entender o R, achei particularmente útil usar recursos de outras linguagens de programação. 
O R possui aspectos retirados de linguagens de programação funcional e de 
linguagens orientadas a objetos (OO). Aprender como esses conceitos são 
representados em R lhe ajudará a alavancar o conhecimento que possui 
em outras linguagens de programação e a identificar áreas nas quais você pode 
melhorar.

Para entender os porquês dos sistemas de objetos de R funcionarem da maneira que 
funcionam, achei particularmente útil o livro _The Structure and Interpretation of Computer Programs_[^SICP] [@SICP] (SICP, em seu acrônimo em inglês - nota do tradutor). 
É um livro conciso, mas profundo, e depois de lê-lo, senti pela primeira vez que 
podia realmente projetar meu próprio sistema orientado a objetos. O livro foi 
minha primeira introdução ao paradigma encapsulado de programação orientada a 
objetos encontrado no R e me ajudou a entender os pontos fortes e fracos desse 
sistema. O SICP também ensina a mentalidade funcional em que você cria funções 
simples individualmente e que se tornam poderosas quando compostas juntas.

[^SICP]: Você pode lê-lo online gratuitamente (em inglês) em <https://mitpress.mit.edu/sites/default/files/sicp/full-text/book/book.html>

Para entender as vantagens e desvantagens que R possui em comparação com outras 
linguagens de programação, achei o livro _Concepts, Techniques and Models of Computer Programming_ [@ctmcp] extremamente útil. Ele me ajudou a entender que a 
semântica de *copy-on-modify* do R facilita bastante o raciocínio sobre o 
código e que, embora sua implementação atual não seja particularmente eficiente, 
é um problema solucionável.

Se você quer aprender a ser um programador melhor, não há lugar melhor para 
buscar isso do que o livro _The Pragmatic Programmer_ [@pragprog]. Este livro 
não trata de uma linguagem de programacao especifica e fornece ótimos conselhos 
sobre como ser um programador melhor.

## Buscando ajuda {#getting-help}
\index{help}
\index{reprex}

Atualmente, existem três locais principais para obter ajuda quando você está 
travadx e não consegue descobrir o que está causando o problema: 
[a Comunidade RStudio](https://community.rstudio.com/), [StackOverflow](http: / /stackoverflow.com) e a [lista de e-mail, R-help][r-help]. 
Você pode obter ajudas fantásticas em cada local, mas cada um tem sua própria
cultura e expectativas. Geralmente, é uma boa ideia gastar um pouco de tempo à 
espreita, aprendendo sobre as expectativas da comunidade, antes de publicar sua 
primeira postagem.

Alguns bons conselhos gerais:

* Verifique se você tem a versão mais recente do R e o(s) pacote(s) com o qual 
  está tendo problemas. Pode ser que o seu problema seja o resultado de um bug 
  corrigido recentemente.

* Passe algum tempo criando um exemplo reproduzível (**repr**oducible 
  **ex**ample, em inglês), ou reprex (acrônimo a partir do nome em inglês - nota 
  do tradutor). Isso ajudará as outras pessoas a lhe ajudar e, muitas vezes, 
  leva a uma solução sem perguntar aos outros. Isso porque, ao tornar o problema 
  reproduzível, você frequentemente descobre a causa raiz. Eu recomendo aprender 
  e usar o pacote [reprex](https://reprex.tidyverse.org/).

<!-- GVW: is someone going to go through once you're done and create a glossary? If you've flagged things like "reprex" in bold, it ought to be easy to find terms. -->

Se você estiver procurando por ajuda específica para resolver os exercícios 
deste livro, as soluções de Malte Grosser e Henning Bumann estão disponíveis em <https://advanced-r-solutions.rbind.io> (em inglês).

## Agradecimentos {#intro-ack}

Gostaria de agradecer as colaborações feitas por várias pessoas do grupos 
R-devel e do R-help e, mais recentemente, do Stack Overflow e da Comunidade 
RStudio. Há muitos nomes para citar individualmente, mas eu gostaria 
particularmente de agradecer a Luke Tierney, John Chambers, JJ Allaire e Brian 
Ripley por generosamente dedicar seu tempo e corrigir meus inúmeros 
mal-entendidos.

Este livro foi [escrito de forma aberta](https://github.com/hadley/adv-r/) e os 
capítulos foram anunciados no [twitter](https://twitter.com/hadleywickham) 
quando concluídos. É realmente um esforço da comunidade: muitas pessoas lêem 
rascunhos, corrigem erros de digitação, sugerem melhorias e contribuem com 
conteúdo. Sem essass pessoas colaborando o livro não seria tão bom quanto é, e 
estou profundamente agradecido pela ajuda de cada um. Agradecimentos especiais a 
Jeff Hammerbacher, Peter Li, Duncan Murdoch e Greg Wilson, que leram o livro de 
capa a capa e forneceram muitas correções e sugestões.

```{r, eval = FALSE, echo = FALSE}
library(tidyverse)
contribs_all_json <- gh::gh("/repos/:owner/:repo/contributors",
  owner = "hadley",
  repo = "adv-r",
  .limit = Inf
)
contribs_all <- tibble(
  login = contribs_all_json %>% map_chr("login"),
  n = contribs_all_json %>% map_int("contributions")
)

contribs_old <- read_csv("contributors.csv", col_types = list())
contribs_new <- contribs_all %>% anti_join(contribs_old, by = "login")

# Get info for new contributors
needed_json <- map(
  contribs_new$login, 
  ~ gh::gh("/users/:username", username = .x)
)
info_new <- tibble(
  login = contribs_new$login,
  name = map_chr(needed_json, "name", .default = NA),
  blog = map_chr(needed_json, "blog", .default = NA)
)
info_old <- contribs_old %>% select(login, name, blog)
info_all <- bind_rows(info_old, info_new)

contribs_all <- contribs_all %>% 
  left_join(info_all, by = "login") %>% 
  arrange(login)
write_csv(contribs_all, "contributors.csv")
```

```{r, results = "asis", echo = FALSE, message = FALSE}
library(dplyr)
contributors <- read.csv("contributors.csv", stringsAsFactors = FALSE)
contributors <- contributors %>% 
  filter(login != "hadley") %>% 
  mutate(
    login = paste0("\\@", login),
    desc = ifelse(is.na(name), login, paste0(name, " (", login, ")"))
  )

cat("Um grande obrigado às ", nrow(contributors), " que contribuíram (em ordem alfabética por username): ", sep = "")
cat(paste0(contributors$desc, collapse = ", "))
cat(".\n")
```

## Convenções {#conventions}
Ao longo deste livro eu uso para me referir a funções
Ao longo deste livro eu uso `f()` para me referir a funções, `g` para me referir 
a variáveis e parâmetros de função, e `h/` para caminhos (*paths - nota do 
tradutor*). 

Blocos de código maiores misturam entrada (input) e saída (output). 
A saída é comentada (`#>`) para que, se você tiver uma versão eletrônica do 
livro, por exemplo, <https://adv-r.hadley.nz/>, possa copiar e colar exemplos 
facilmente no R.

Muitos exemplos usam números aleatórios. Você pode reproduzi-los usando o 
comando `set.seed (1014)`, que é executado automaticamente no início de cada 
capítulo.

\newpage
## Cólofon {#colophon}

Este livro foi escrito (e traduzido - nota do tradutor) usando [bookdown](http://bookdown.org/) dentro de [RStudio](http://www.rstudio.com/ide/). 
O [site](https://adv-r.hadley.nz/) é hospedado no [netlify](http://netlify.com/) 
e atualizado automaticamente após cada confirmação usando [travis-ci](https: //travis-ci.org/). 
O código-fonte completo está disponível no [GitHub](https://github.com/hadley/adv-r). 
A fonte do texto do código no livro impresso é a [inconsolata](http://levien.com/type/myfonts/inconsolata.html). 
As imagens de emoji no livro impresso são provenientes do pacote [Twitter Emoji](https://github.com/twitter/twemoji), que possui licença livre.

Esta versão do livro foi construída com `r R.version.string` e os seguintes 
pacotes.

```{r, echo = FALSE, results="asis"}
deps <- desc::desc_get_deps()$package[-1]

pkgs <- sessioninfo::package_info(deps, dependencies = FALSE)
df <- tibble(
  pacote = pkgs$package,
  versao = pkgs$ondiskversion,
  fonte = gsub("@", "\\\\@", pkgs$source)
)
knitr::kable(df, format = "markdown")
```

```{r, include = FALSE}
ruler <- function(width = getOption("width")) {
  x <- seq_len(width)
  y <- case_when(
    x %% 10 == 0 ~ as.character((x %/% 10) %% 10),
    x %% 5 == 0  ~ "+",
    TRUE         ~ "-"
  )
  cat(y, "\n", sep = "")
  cat(x %% 10, "\n", sep = "")
}

ruler()
```

[r-help]: https://stat.ethz.ch/mailman/listinfo/r-help
[rstats-twitter]: https://twitter.com/search?q=%23rstats
[r-meetups]: https://www.meetup.com/topics/r-programming-language/
[rweekly]: https://rweekly.org
[r-ladies]: http://r-ladies.org
[rmarkdown]: https://rmarkdown.rstudio.com
[shiny]: http://shiny.rstudio.com
